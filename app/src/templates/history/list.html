{% extends "base.html" %}

{% block content %}
<!-- Header Section -->
<div class="section-header mb-4 fade-in">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <h2 class="section-title mb-0">
            <i class="bi bi-clock-history text-primary"></i>
            Stock Movement History
        </h2>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#filterSection">
                <i class="bi bi-funnel me-2"></i>Filters
            </button>
            <button type="button" class="btn btn-primary hover-lift" onclick="location.href='{{ url_for('history.add_history') }}'">
                <i class="bi bi-plus-circle me-2"></i>Record Movement
            </button>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div id="filterSection" class="collapse show mb-4">
    <div class="card bg-dark border fade-in">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <label for="product" class="form-label small text-muted">Product</label>
                    <select class="form-select form-select-sm" id="product" name="product">
                        <option value="">All Products</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" {% if request.args.get('product')|int == product.id %}selected{% endif %}>
                            {{ product.product_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 col-sm-6">
                    <label for="type" class="form-label small text-muted">Movement Type</label>
                    <select class="form-select form-select-sm" id="type" name="type">
                        <option value="">All Types</option>
                        <option value="in" {% if request.args.get('type') == 'in' %}selected{% endif %}>Stock In</option>
                        <option value="out" {% if request.args.get('type') == 'out' %}selected{% endif %}>Stock Out</option>
                    </select>
                </div>
                <div class="col-md-3 col-sm-6">
                    <label for="start_date" class="form-label small text-muted">Start Date</label>
                    <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" 
                           value="{{ request.args.get('start_date', '') }}">
                </div>
                <div class="col-md-3 col-sm-6">
                    <label for="end_date" class="form-label small text-muted">End Date</label>
                    <input type="date" class="form-control form-control-sm" id="end_date" name="end_date" 
                           value="{{ request.args.get('end_date', '') }}">
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" id="resetFilters" class="btn btn-outline-secondary btn-sm hover-scale">
                        <i class="bi bi-x-circle me-2"></i>Reset
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm hover-scale">
                        <i class="bi bi-funnel me-2"></i>Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-4 mb-4 fade-in">
    <div class="col-md-4">
        <div class="card hover-lift h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper bg-primary-soft rounded-3 p-3 me-3">
                        <i class="bi bi-arrow-left-right fs-3 text-primary"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle mb-1 text-muted">Total Movements</h6>
                        <h2 class="card-title mb-0 display-6">{{ histories|length }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card hover-lift h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper bg-success-soft rounded-3 p-3 me-3">
                        <i class="bi bi-box-arrow-in-right fs-3 text-success"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle mb-1 text-muted">Total Stock In</h6>
                        <h2 class="card-title mb-0 display-6 text-success">{{ total_in }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card hover-lift h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper bg-danger-soft rounded-3 p-3 me-3">
                        <i class="bi bi-box-arrow-right fs-3 text-danger"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle mb-1 text-muted">Total Stock Out</h6>
                        <h2 class="card-title mb-0 display-6 text-danger">{{ total_out }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- History Table -->
<div class="card bg-dark border hover-shadow fade-in">
    <div class="card-body">
        <div class="table-responsive">
            <table id="historyTable" class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Product</th>
                        <th class="text-center" style="width: 120px;">Type</th>
                        <th class="text-end" style="width: 100px;">Quantity</th>
                        <th>Reference</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history in histories %}
                    <tr class="fade-in" style="--delay: {{ loop.index * 0.05 }}s">
                        <td class="text-nowrap fw-medium">{{ history.date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ history.inventory.product_name }}</td>
                        <td class="text-center">
                            <span class="badge {% if history.type == 'in' %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                                <i class="bi {% if history.type == 'in' %}bi-box-arrow-in-right{% else %}bi-box-arrow-right{% endif %} me-1"></i>
                                {{ history.type|upper }}
                            </span>
                        </td>
                        <td class="text-end fw-medium">{{ history.quantity }}</td>
                        <td>
                            {% if history.reference %}
                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ history.reference }}">
                                {{ history.reference|truncate(30) }}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if history.notes %}
                            <span data-bs-toggle="tooltip" data-bs-placement="top" title="{{ history.notes }}">
                                {{ history.notes|truncate(50) }}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
     style="background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="position-absolute top-50 start-50 translate-middle text-light">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initialize DataTable with configuration
    var table = $('#historyTable').DataTable({
        order: [[0, 'desc']],
        pageLength: 25,
        dom: '<"row mb-3"<"col-md-6"B><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
        buttons: [
            {
                extend: 'collection',
                text: '<i class="bi bi-download me-2"></i>Export',
                className: 'btn btn-secondary btn-sm hover-scale',
                buttons: [
                    {
                        extend: 'csv',
                        text: '<i class="bi bi-filetype-csv me-2"></i>CSV',
                        className: 'btn btn-sm btn-dark hover-scale'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-earmark-excel me-2"></i>Excel',
                        className: 'btn btn-sm btn-success hover-scale'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="bi bi-file-earmark-pdf me-2"></i>PDF',
                        className: 'btn btn-sm btn-danger hover-scale'
                    },
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer me-2"></i>Print',
                        className: 'btn btn-sm btn-info hover-scale'
                    }
                ]
            }
        ],
        language: {
            search: "",
            searchPlaceholder: "Search records...",
            lengthMenu: "_MENU_ per page",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            paginate: {
                first: '<i class="bi bi-chevron-double-left"></i>',
                last: '<i class="bi bi-chevron-double-right"></i>',
                next: '<i class="bi bi-chevron-right"></i>',
                previous: '<i class="bi bi-chevron-left"></i>'
            }
        }
    });

    // Enhance DataTable styling
    $('.dataTables_wrapper .dataTables_filter input').addClass('form-control form-control-sm ms-2');
    $('.dataTables_wrapper .dataTables_length select').addClass('form-select form-select-sm mx-2');

    // Handle filter form submission with loading overlay
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        $('#loadingOverlay').removeClass('d-none');
        var formData = new FormData(this);
        var params = new URLSearchParams(formData);
        window.location.href = "{{ url_for('history.history_list') }}?" + params.toString();
    });

    // Reset filters with loading overlay
    $('#resetFilters').on('click', function() {
        $('#loadingOverlay').removeClass('d-none');
        window.location.href = "{{ url_for('history.history_list') }}";
    });

    // Handle export button clicks
    $('.dt-button').on('click', function() {
        $('#loadingOverlay').removeClass('d-none');
        setTimeout(function() {
            $('#loadingOverlay').addClass('d-none');
        }, 1000);
    });
});
</script>
{% endblock %}
