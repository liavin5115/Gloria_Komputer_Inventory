{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Stock Movement History</h2>
        <div>
            <a href="{{ url_for('history.export_history') }}{{ '?' + request.query_string.decode() if request.query_string else '' }}"
               class="btn btn-success me-2">Export to CSV</a>
            <a href="{{ url_for('history.add_history') }}" class="btn btn-primary">Record Stock Movement</a>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="product" class="form-label">Product</label>
                    <select class="form-select" id="product" name="product">
                        <option value="">All Products</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" {% if request.args.get('product')|int == product.id %}selected{% endif %}>
                            {{ product.product_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="type" class="form-label">Movement Type</label>
                    <select class="form-select" id="type" name="type">
                        <option value="">All Types</option>
                        <option value="in" {% if request.args.get('type') == 'in' %}selected{% endif %}>Stock In</option>
                        <option value="out" {% if request.args.get('type') == 'out' %}selected{% endif %}>Stock Out</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ request.args.get('start_date', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date"
                           value="{{ request.args.get('end_date', '') }}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Total Stock In</h6>
                    <p class="card-text h4">{{ total_in }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Total Stock Out</h6>
                    <p class="card-text h4">{{ total_out }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Total Movements</h6>
                    <p class="card-text h4">{{ histories|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table id="historyTable" class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Product</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Reference</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for history in histories %}
                <tr>
                    <td data-order="{{ history.date.strftime('%Y%m%d%H%M') }}">
                        {{ history.date.strftime('%Y-%m-%d %H:%M') }} WIB
                    </td>
                    <td>{{ history.inventory.product_name }}</td>
                    <td>
                        <span class="badge {% if history.type == 'in' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ 'Stock In' if history.type == 'in' else 'Stock Out' }}
                        </span>
                    </td>
                    <td data-order="{{ history.quantity }}">{{ history.quantity }}</td>
                    <td>{{ history.reference }}</td>
                    <td>{{ history.notes }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#historyTable').DataTable({
        dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rtip',
        buttons: [
            {
                extend: 'collection',
                text: '<i class="bi bi-download me-2"></i>Export',
                className: 'btn btn-primary',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="bi bi-clipboard me-2"></i>Copy',
                        className: 'btn btn-light'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="bi bi-file-earmark-excel me-2"></i>Excel',
                        className: 'btn btn-success'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="bi bi-file-earmark-pdf me-2"></i>PDF',
                        className: 'btn btn-danger'
                    },
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer me-2"></i>Print',
                        className: 'btn btn-info'
                    }
                ]
            }
        ],
        pageLength: 10,
        order: [[0, 'desc']], // Sort by date descending
        responsive: true,
        language: {
            search: "Search:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    // Apply filters when form is submitted
    $('form').on('submit', function(e) {
        e.preventDefault();
        
        // Collect filter values
        let product = $('#product').val();
        let type = $('#type').val();
        let startDate = $('#start_date').val();
        let endDate = $('#end_date').val();
        
        // Clear previous filters
        table.search('').columns().search('').draw();
        
        // Apply product filter
        if (product) {
            table.column(1).search($('#product option:selected').text()).draw();
        }
        
        // Apply type filter
        if (type) {
            let typeText = type === 'in' ? 'Stock In' : 'Stock Out';
            table.column(2).search(typeText).draw();
        }
        
        // Apply date range filter
        if (startDate || endDate) {
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                let date = new Date(data[0].split(' ')[0]);
                let start = startDate ? new Date(startDate) : null;
                let end = endDate ? new Date(endDate) : null;
                
                if (start && date < start) return false;
                if (end && date > end) return false;
                return true;
            });
        }
        
        table.draw();
    });

    // Reset filters
    $('#resetFilters').on('click', function() {
        $('form')[0].reset();
        table.search('').columns().search('').draw();
        $.fn.dataTable.ext.search.pop();
    });
});
</script>
{% endblock %}
