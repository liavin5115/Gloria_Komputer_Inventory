{% extends "base.html" %}

{% block content %}
<div class="section-header mb-4 fade-in">
    <div>
        <h1 class="mb-2 display-4">Selamat Datang di Gloria Komputer</h1>
        <p class="lead mb-0 text-muted">Kelola inventaris komponen dan aksesoris komputer Anda dengan efisien.</p>
    </div>
</div>

<div class="row g-4">
    <!-- Overview Stats -->
    <div class="col-md-8">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <div>
                                <h6 class="card-title">Total Penjualan Bulan Ini</h6>
                                <h3 class="counter-value stat-value">Rp. {{ "{:,.0f}".format(monthly_sales) }}</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-primary" style="width: 75%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div>
                                <h6 class="card-title">Total Produk</h6>
                                <h3 class="counter-value stat-value">{{ total_products }}</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-success" style="width: 65%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <div>
                                <h6 class="card-title">Penjualan Hari Ini</h6>
                                <h3 class="counter-value stat-value">Rp. {{ "{:,.0f}".format(daily_sales) }}</h3>
                                <small class="text-muted">Hari ini</small>
                            </div>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-warning" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-wrapper me-3">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div>
                                <h6 class="card-title">Stok Menipis</h6>
                                <h3 class="counter-value stat-value">{{ low_stock }}</h3>
                            </div>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-danger" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="col-md-4">
        <div class="data-card" style="height: 100%;">
            <div class="card-body">
                <h6 class="card-title mb-3">Distribusi Kategori</h6>
                <canvas id="categoryChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Sales Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="data-card">
            <div class="card-body">
                <h6 class="card-title mb-3">Grafik Penjualan</h6>
                <canvas id="salesChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

{% if low_stock_items %}
<div class="row mt-4 fade-in">
    <div class="col-12">
        <div class="data-card">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="bi bi-exclamation-triangle me-2 text-warning"></i>Peringatan Stok Menipis
                </h6>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Nama Produk</th>
                                <th>Kategori</th>
                                <th>Stok Tersedia</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td>{{ item.product_name }}</td>
                                <td>{{ item.category }}</td>
                                <td>
                                    <span class="badge bg-danger">{{ item.quantity }}</span>
                                </td>
                                <td>
                                    <a href="{{ url_for('restock.add_restock') }}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-cart-plus"></i> Restock
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const counterElements = document.querySelectorAll('.counter-value');
    counterElements.forEach(counter => {
        // Store the original value
        const originalValue = counter.textContent;
        if (isNaN(parseInt(originalValue))) return;
        
        const updateCounter = () => {
            const target = parseInt(originalValue);
            const current = parseInt(counter.textContent);
            const increment = Math.ceil(target / 20);
            
            if (current < target) {
                counter.textContent = Math.min(current + increment, target);
                requestAnimationFrame(updateCounter);
            }
        };
        
        // Start from 0
        counter.textContent = '0';
        // Begin animation
        requestAnimationFrame(updateCounter);
    });
});
</script>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.querySelector('[data-theme-icon]');
    const htmlElement = document.documentElement;
    
    function setTheme(isDark) {
        htmlElement.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
        themeIcon.className = isDark ? 'bi bi-moon-fill text-light' : 'bi bi-sun-fill text-warning';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme === 'dark');
    
    themeToggle.addEventListener('click', () => {
        const isDark = htmlElement.getAttribute('data-bs-theme') === 'dark';
        setTheme(!isDark);
    });

    // Sales Chart Configuration
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    const gradientFill = salesCtx.createLinearGradient(0, 0, 0, 400);
    gradientFill.addColorStop(0, 'rgba(79, 70, 229, 0.3)');
    gradientFill.addColorStop(1, 'rgba(79, 70, 229, 0.02)');

    const salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: {{ months_labels|tojson }},
            datasets: [
                {
                    label: 'Penjualan',
                    data: {{ sales_values|tojson }},
                    borderColor: '#3b82f6',
                    backgroundColor: gradientFill,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Keuntungan',
                    data: {{ profit_values|tojson }},
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += new Intl.NumberFormat('id-ID', {
                                style: 'currency',
                                currency: 'IDR'
                            }).format(context.parsed.y);
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return new Intl.NumberFormat('id-ID', {
                                style: 'currency',
                                currency: 'IDR',
                                maximumSignificantDigits: 3
                            }).format(value);
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    // Category Distribution Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: {{ category_labels|tojson }},
            datasets: [{
                data: {{ category_counts|tojson }},
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',   // Blue
                    'rgba(16, 185, 129, 0.8)',   // Green
                    'rgba(245, 158, 11, 0.8)',   // Yellow
                    'rgba(239, 68, 68, 0.8)',    // Red
                    'rgba(167, 139, 250, 0.8)',  // Purple
                    'rgba(14, 165, 233, 0.8)',   // Sky Blue
                    'rgba(249, 115, 22, 0.8)',   // Orange
                    'rgba(108, 117, 125, 0.8)'   // Gray
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true
            }
        }
    });

    // Counter animation
    const counterElements = document.querySelectorAll('.counter-value');
    counterElements.forEach(counter => {
        const target = parseFloat(counter.dataset.value) || parseFloat(counter.textContent);
        if (isNaN(target)) return;

        const duration = 1500;
        const startTime = performance.now();
        const startValue = 0;

        function updateCounter(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            const currentValue = progress * target;
            
            if (counter.textContent.includes('Rp')) {
                counter.textContent = 'Rp. ' + new Intl.NumberFormat('id-ID').format(Math.floor(currentValue));
            } else {
                counter.textContent = Math.floor(currentValue);
            }

            if (progress < 1) {
                requestAnimationFrame(updateCounter);
            }
        }

        requestAnimationFrame(updateCounter);
    });
});
</script>
{% endblock %}
{% endblock %}
